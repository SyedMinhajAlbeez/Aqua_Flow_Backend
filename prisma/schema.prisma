// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== ENUMS (Best Practice) ====================
enum UserRole {
  super_admin
  company_admin
  company_user
}

enum OrderStatus {
  pending
  confirmed
  in_progress
  out_for_delivery
  delivered // sirf paani diya, empties abhi nahi liye
  assigned
  completed // ← NAYA: paani + empties collect → final
  cancelled
  failed
}

enum PaymentMethod {
  cash_on_delivery
  card
  wallet
  bank_transfer
}

enum CustomerStatus {
  active
  inactive
  sleeping
  overdue
}

enum OrderRecurrence {
  NONE
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

// ==================== USER & TENANT ====================
model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  password     String?
  role         UserRole  @default(company_admin)
  phone        String?
  address      String?
  logo         String?
  otp          String?
  tenantId     String? // NULL for super_admin
  lastActivity DateTime? @default(now())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant             Tenant?            @relation("UserBelongsToTenant", fields: [tenantId], references: [id])
  keptTenants        Tenant[]           @relation("TenantKeeper")
  productInventories ProductInventory[]
  products           Product[]
  zones              Zone[]
  drivers            Driver[]
  orders             Order[]

  @@map("users")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  phone     String?
  address   String?
  status    String   @default("active")
  logo      String?
  keeperId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  keeper             User               @relation("TenantKeeper", fields: [keeperId], references: [id])
  users              User[]             @relation("UserBelongsToTenant")
  products           Product[]
  customers          Customer[]
  zones              Zone[]
  drivers            Driver[]
  orders             Order[]
  bottleInventory    BottleInventory?
  productInventories ProductInventory[]
  subscriptions      Subscription[]

  @@map("tenants")
}

// ==================== PRODUCT ====================
model Product {
  id                  String   @id @default(uuid())
  name                String
  size                String
  isReusable          Boolean  @default(false)
  depositAmount       Float    @default(0)
  requiresEmptyReturn Boolean  @default(false)
  price               Float
  image               String?
  status              String   @default("active")
  tenantId            String
  userId              String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])
  orderItems OrderItem[]

  // ← YEHI SAHI HAI (no extra field, no duplicate)
  inventory     ProductInventory? @relation("ProductInventoryRelation")
  subscriptions Subscription[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, size])
  @@index([tenantId, isReusable])
  @@map("products")
}

// prisma/schema.prisma mein yeh naya model add kar de
model ProductInventory {
  id        String  @id @default(uuid())
  productId String  @unique
  product   Product @relation("ProductInventoryRelation", fields: [productId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  currentStock Int @default(0)
  totalSold    Int @default(0)
  totalAdded   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@unique([productId, tenantId])
  @@index([tenantId])
  @@index([productId])
  @@map("product_inventories")
}

model BottleInventory {
  id       String @id @default(uuid())
  tenantId String @unique // Ek company ka sirf ek inventory record

  // ==================== MAIN STOCK COUNTERS ====================
  totalPurchased Int @default(0) // Company ne ab tak kitne reusable bottles kharide
  inStock        Int @default(0) // Godown mein available (ready for delivery)
  withCustomers  Int @default(0) // Customers ke paas kitne empties hain (total circulating)

  // ==================== LOSS & RECOVERY ====================
  damaged    Int @default(0) // Customer ne damage kiye → customer pay karega
  leaked     Int @default(0) // Leak hue → company ka loss (no recovery)
  repairable Int @default(0) // Damage hue lekin repair ho sakte hain
  lost       Int @default(0) // Gayab / misplaced → customer se full deposit deduct

  // ==================== RELATION ====================
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("bottle_inventories")
}

// ==================== ZONE ====================
model Zone {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  userId   String?
  user     User?   @relation(fields: [userId], references: [id])

  drivers   Driver[]
  customers Customer[]
  orders    Order[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@map("zones")
}

// ==================== CUSTOMER ====================
model Customer {
  id         String  @id @default(uuid())
  name       String
  phone      String
  address    String
  email      String?
  city       String?
  postalCode String?
  country    String?

  zoneId String?
  zone   Zone?   @relation(fields: [zoneId], references: [id])

  totalSpent      Float @default(0)
  dueAmount       Float @default(0)
  securityDeposit Float @default(0)
  empties         Int   @default(0)
  bottlesGiven    Int   @default(0)

  status        CustomerStatus @default(active)
  lastOrderDate DateTime?
  sleepingSince DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId      String
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  orders        Order[]
  subscriptions Subscription[]

  @@unique([phone, tenantId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([phone])
  @@index([lastOrderDate])
  @@index([zoneId])
  @@map("customers")
}

// ==================== DRIVER ====================
model Driver {
  id            String @id @default(uuid())
  name          String
  phone         String
  vehicleNumber String // e.g. "KHI-456", "Bike-01" (clear & searchable)
  vehicleType   String // "bike", "loader", "van", "car", "rickshaw"

  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id])

  status          String @default("active") // active, inactive, on_leave
  rating          Float? // Average rating (null = no ratings yet)
  totalRatings    Int    @default(0) // Total number of ratings received
  totalDeliveries Int    @default(0)
  todayDeliveries Int    @default(0) // Daily reset by cron

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  userId   String?
  user     User?   @relation(fields: [userId], references: [id])
  orders   Order[]

  @@unique([phone, tenantId])
  @@unique([vehicleNumber, tenantId]) // No duplicate vehicles
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([zoneId])
  @@index([phone])
  @@index([vehicleNumber])
  @@index([status])
  @@map("drivers")
}

model Subscription {
  id         String @id @default(uuid())
  customerId String
  tenantId   String

  // Subscription details
  productId         String
  quantity          Int             @default(1)
  recurrence        OrderRecurrence @default(WEEKLY)
  deliveryDayOfWeek Int // 0=Sunday, 1=Monday, ... 6=Saturday
  nextDeliveryDate  DateTime // Next delivery date (auto-calculated)
  lastDeliveredDate DateTime? // Last successful delivery

  // Customer preferences
  preferredTime    String? // e.g., "Morning", "Afternoon", "Evening"
  notificationTime Int     @default(21) // 9 PM (hours 0-23)

  // Status & tracking
  status           SubscriptionStatus @default(ACTIVE)
  totalDeliveries  Int                @default(0)
  missedDeliveries Int                @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  customer Customer @relation(fields: [customerId], references: [id])
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  product  Product  @relation(fields: [productId], references: [id])
  orders   Order[] // All orders from this subscription

  @@unique([customerId, productId, recurrence, deliveryDayOfWeek])
  @@index([customerId])
  @@index([tenantId])
  @@index([status])
  @@index([nextDeliveryDate])
  @@map("subscriptions")
}

// ==================== ORDER ====================
model Order {
  id                 String @id @default(uuid())
  orderNumber        Int    @unique @default(autoincrement())
  orderNumberDisplay String @unique // "#1001", "#1002" → create time par set hoga

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id])

  zoneId                  String
  zone                    Zone            @relation(fields: [zoneId], references: [id])
  scheduledDate           DateTime?
  deliveryDate            DateTime
  deliveryAddress         String
  totalAmount             Float
  acceptableDepositAmount Float           @default(0)
  paymentMethod           PaymentMethod   @default(cash_on_delivery)
  status                  OrderStatus     @default(pending)
  // Add these new fields
  subscriptionId          String?
  isRecurring             Boolean         @default(false)
  withBottles             Boolean         @default(true) // true = bottles dena, false = sirf refill
  recurrence              OrderRecurrence @default(NONE)
  nextRecurringDate       DateTime?
  notificationSent        Boolean         @default(false)

  items OrderItem[]

  tenantId    String
  tenant      Tenant  @relation(fields: [tenantId], references: [id])
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([isRecurring])
  @@index([nextRecurringDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deliveryDate])
  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([driverId])
  @@index([orderNumberDisplay])
  @@map("orders")
}

// ==================== ORDER ITEM ====================
model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity      Int
  unitPrice     Float
  depositAmount Float @default(0)
  totalPrice    Float

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}
