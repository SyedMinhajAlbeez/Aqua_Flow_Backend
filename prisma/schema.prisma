generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String             @id @default(uuid())
  name               String
  email              String             @unique
  password           String?
  tenantId           String?
  lastActivity       DateTime?          @default(now())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  address            String?
  logo               String?
  otp                String?
  phone              String?
  role               UserRole           @default(company_admin)
  drivers            Driver[]
  orders             Order[]
  productInventories ProductInventory[]
  products           Product[]
  keptTenants        Tenant[]           @relation("TenantKeeper")
  tenant             Tenant?            @relation("UserBelongsToTenant", fields: [tenantId], references: [id])
  zones              Zone[]

  @@map("users")
}

model Tenant {
  id                 String             @id @default(uuid())
  name               String
  keeperId           String
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  address            String?
  email              String?            @unique
  logo               String?
  phone              String?
  status             String             @default("active")
  bottleInventory    BottleInventory?
  customers          Customer[]
  drivers            Driver[]
  orders             Order[]
  payments           Payment[]
  productInventories ProductInventory[]
  products           Product[]
  subscriptions      Subscription[]
  keeper             User               @relation("TenantKeeper", fields: [keeperId], references: [id])
  users              User[]             @relation("UserBelongsToTenant")
  zones              Zone[]

  @@map("tenants")
}

model Product {
  id                  String            @id @default(uuid())
  name                String
  price               Float
  tenantId            String
  userId              String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  image               String?
  status              String            @default("active")
  size                String
  depositAmount       Float             @default(0)
  isReusable          Boolean           @default(false)
  requiresEmptyReturn Boolean           @default(false)
  orderItems          OrderItem[]
  inventory           ProductInventory? @relation("ProductInventoryRelation")
  tenant              Tenant            @relation(fields: [tenantId], references: [id])
  user                User?             @relation(fields: [userId], references: [id])
  subscriptions       Subscription[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, size])
  @@index([tenantId, isReusable])
  @@map("products")
}

model Payment {
  id                  String                @id @default(uuid())
  paymentNumber       String                @unique
  customerId          String
  tenantId            String
  orderId             String?
  subscriptionId      String?
  amount              Float
  paidAmount          Float                 @default(0)
  pendingAmount       Float                 @default(0)
  collectionType      PaymentCollectionType @default(IMMEDIATE)
  dueDate             DateTime
  paymentDate         DateTime?
  status              PaymentStatus         @default(PENDING)
  paymentMethod       PaymentMethod         @default(cash_on_delivery)
  month               Int?
  year                Int?
  cycleStartDate      DateTime?
  cycleEndDate        DateTime?
  collectedByDriverId String?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  paymentItems        PaymentItem[]
  collectedByDriver   Driver?               @relation(fields: [collectedByDriverId], references: [id])
  customer            Customer              @relation(fields: [customerId], references: [id])
  order               Order?                @relation(fields: [orderId], references: [id])
  subscription        Subscription?         @relation(fields: [subscriptionId], references: [id])
  tenant              Tenant                @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([customerId])
  @@index([subscriptionId])
  @@index([orderId])
  @@index([status])
  @@index([dueDate])
  @@map("payments")
}

model PaymentItem {
  id            String    @id @default(uuid())
  paymentId     String
  orderId       String
  orderItemId   String
  productName   String
  quantity      Int
  unitPrice     Float
  depositAmount Float     @default(0)
  totalAmount   Float
  order         Order     @relation(fields: [orderId], references: [id])
  orderItem     OrderItem @relation(fields: [orderItemId], references: [id])
  payment       Payment   @relation(fields: [paymentId], references: [id])

  @@map("payment_items")
}

model ProductInventory {
  id           String   @id @default(uuid())
  productId    String   @unique
  tenantId     String
  currentStock Int      @default(0)
  totalAdded   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String?
  totalSold    Int      @default(0)
  product      Product  @relation("ProductInventoryRelation", fields: [productId], references: [id])
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  @@unique([productId, tenantId])
  @@index([tenantId])
  @@index([productId])
  @@map("product_inventories")
}

model BottleInventory {
  id             String @id @default(uuid())
  tenantId       String @unique
  totalPurchased Int    @default(0)
  inStock        Int    @default(0)
  withCustomers  Int    @default(0)
  damaged        Int    @default(0)
  leaked         Int    @default(0)
  repairable     Int    @default(0)
  lost           Int    @default(0)
  tenant         Tenant @relation(fields: [tenantId], references: [id])

  @@map("bottle_inventories")
}

model Zone {
  id          String     @id @default(uuid())
  name        String
  description String?
  status      String     @default("active")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  tenantId    String
  userId      String?
  customers   Customer[]
  drivers     Driver[]
  orders      Order[]
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  user        User?      @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
  @@map("zones")
}

model Customer {
  id              String         @id @default(uuid())
  name            String
  phone           String
  address         String
  email           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  tenantId        String
  bottlesGiven    Int            @default(0)
  dueAmount       Float          @default(0)
  empties         Int            @default(0)
  lastOrderDate   DateTime?
  securityDeposit Float          @default(0)
  sleepingSince   DateTime?
  totalSpent      Float          @default(0)
  city            String?
  country         String?
  postalCode      String?
  zoneId          String?
  status          CustomerStatus @default(active)
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  zone            Zone?          @relation(fields: [zoneId], references: [id])
  orders          Order[]
  payments        Payment[]
  subscriptions   Subscription[]

  @@unique([phone, tenantId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([phone])
  @@index([lastOrderDate])
  @@index([zoneId])
  @@map("customers")
}

model Driver {
  id              String    @id @default(uuid())
  name            String
  phone           String
  zoneId          String
  status          String    @default("active")
  rating          Float?
  totalDeliveries Int       @default(0)
  todayDeliveries Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  tenantId        String
  userId          String?
  totalRatings    Int       @default(0)
  vehicleNumber   String
  vehicleType     String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  user            User?     @relation(fields: [userId], references: [id])
  zone            Zone      @relation(fields: [zoneId], references: [id])
  orders          Order[]
  payments        Payment[]

  @@unique([phone, tenantId])
  @@unique([vehicleNumber, tenantId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([zoneId])
  @@index([phone])
  @@index([vehicleNumber])
  @@index([status])
  @@map("drivers")
}

model Subscription {
  id                String             @id @default(uuid())
  customerId        String
  tenantId          String
  productId         String
  quantity          Int                @default(1)
  recurrence        OrderRecurrence    @default(WEEKLY)
  deliveryDayOfWeek Int
  nextDeliveryDate  DateTime
  lastDeliveredDate DateTime?
  preferredTime     String?
  notificationTime  Int                @default(21)
  status            SubscriptionStatus @default(ACTIVE)
  totalDeliveries   Int                @default(0)
  missedDeliveries  Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  orders            Order[]
  payments          Payment[]
  customer          Customer           @relation(fields: [customerId], references: [id])
  product           Product            @relation(fields: [productId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])

  @@unique([customerId, productId, recurrence, deliveryDayOfWeek])
  @@index([customerId])
  @@index([tenantId])
  @@index([status])
  @@index([nextDeliveryDate])
  @@map("subscriptions")
}

model Order {
  id                      String          @id @default(uuid())
  orderNumber             Int             @unique @default(autoincrement())
  orderNumberDisplay      String          @unique
  customerId              String
  driverId                String?
  zoneId                  String
  deliveryDate            DateTime
  deliveryAddress         String
  totalAmount             Float
  paymentMethod           PaymentMethod   @default(cash_on_delivery)
  status                  OrderStatus     @default(pending)
  tenantId                String
  createdById             String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  acceptableDepositAmount Float           @default(0)
  scheduledDate           DateTime?
  isRecurring             Boolean         @default(false)
  nextRecurringDate       DateTime?
  notificationSent        Boolean         @default(false)
  recurrence              OrderRecurrence @default(NONE)
  subscriptionId          String?
  withBottles             Boolean         @default(true)
  paidAmount              Float           @default(0)
  paymentId               String?
  paymentStatus           PaymentStatus   @default(PENDING)
  items                   OrderItem[]
  createdBy               User?           @relation(fields: [createdById], references: [id])
  customer                Customer        @relation(fields: [customerId], references: [id])
  driver                  Driver?         @relation(fields: [driverId], references: [id])
  subscription            Subscription?   @relation(fields: [subscriptionId], references: [id])
  tenant                  Tenant          @relation(fields: [tenantId], references: [id])
  zone                    Zone            @relation(fields: [zoneId], references: [id])
  paymentItems            PaymentItem[]
  payments                Payment[]

  @@index([subscriptionId])
  @@index([isRecurring])
  @@index([nextRecurringDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deliveryDate])
  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([driverId])
  @@index([orderNumberDisplay])
  @@map("orders")
}

model OrderItem {
  id            String        @id @default(uuid())
  orderId       String
  productId     String
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  depositAmount Float         @default(0)
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])
  paymentItems  PaymentItem[]

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

enum UserRole {
  super_admin
  company_admin
  company_user
}

enum OrderStatus {
  pending
  confirmed
  in_progress
  out_for_delivery
  delivered
  completed
  cancelled
  failed
  assigned
}

enum PaymentMethod {
  cash_on_delivery
  card
  wallet
  bank_transfer
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum PaymentCollectionType {
  IMMEDIATE
  MONTHLY
  CYCLE
}

enum CustomerStatus {
  active
  inactive
  sleeping
  overdue
}

enum OrderRecurrence {
  NONE
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}
