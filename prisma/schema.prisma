generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String             @id @default(uuid())
  name               String
  email              String             @unique
  password           String?
  tenantId           String?
  lastActivity       DateTime?          @default(now())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  address            String?
  logo               String?
  otp                String?
  phone              String?
  role               UserRole           @default(company_admin)
  drivers            Driver[]
  orders             Order[]
  productInventories ProductInventory[]
  products           Product[]
  keptTenants        Tenant[]           @relation("TenantKeeper")
  tenant             Tenant?            @relation("UserBelongsToTenant", fields: [tenantId], references: [id])
  zones              Zone[]

  @@map("users")
}

model Tenant {
  id                 String             @id @default(uuid())
  name               String
  keeperId           String
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  address            String?
  email              String?            @unique
  logo               String?
  phone              String?
  status             String             @default("active")
  companyTariffs     CompanyTariff[]
  bottleInventory    BottleInventory?
  customers          Customer[]
  drivers            Driver[]
  orders             Order[]
  customerPayments   CustomerPayment[] // Company's customer payments
  invoicePayments    InvoicePayment[] // Company's invoice payments
  productInventories ProductInventory[]
  products           Product[]
  subscriptions      Subscription[]
  keeper             User               @relation("TenantKeeper", fields: [keeperId], references: [id])
  users              User[]             @relation("UserBelongsToTenant")
  zones              Zone[]
  invoices           Invoice[]

  @@map("tenants")
}

model Product {
  id                  String            @id @default(uuid())
  name                String
  price               Float
  tenantId            String
  userId              String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  image               String?
  status              String            @default("active")
  size                String
  depositAmount       Float             @default(0)
  isReusable          Boolean           @default(false)
  requiresEmptyReturn Boolean           @default(false)
  orderItems          OrderItem[]
  inventory           ProductInventory? @relation("ProductInventoryRelation")
  tenant              Tenant            @relation(fields: [tenantId], references: [id])
  user                User?             @relation(fields: [userId], references: [id])
  subscriptions       Subscription[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, size])
  @@index([tenantId, isReusable])
  @@map("products")
}

model CustomerPayment {
  id                  String                @id @default(uuid())
  paymentNumber       String                @unique @default(uuid())
  customerId          String?
  tenantId            String // Company receiving payment
  orderId             String?
  subscriptionId      String?
  amount              Float
  paidAmount          Float                 @default(0)
  pendingAmount       Float                 @default(0)
  collectionType      PaymentCollectionType @default(IMMEDIATE)
  dueDate             DateTime?
  paymentDate         DateTime?
  status              PaymentStatus         @default(PENDING)
  paymentMethod       PaymentMethod         @default(cash_on_delivery)
  month               Int?
  year                Int?
  cycleStartDate      DateTime?
  cycleEndDate        DateTime?
  collectedByDriverId String?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  // Relations
  paymentItems      PaymentItem[]
  collectedByDriver Driver?       @relation(fields: [collectedByDriverId], references: [id])
  customer          Customer?     @relation(fields: [customerId], references: [id])
  order             Order?        @relation(fields: [orderId], references: [id])
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  tenant            Tenant        @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([customerId])
  @@index([subscriptionId])
  @@index([orderId])
  @@index([status])
  @@index([dueDate])
  @@index([paymentDate])
  @@map("customer_payments")
}

model InvoicePayment {
  id            String        @id @default(uuid())
  invoiceId     String
  tenantId      String // Company making the payment
  amount        Float
  paidAt        DateTime      @default(now())
  paymentMethod PaymentMethod @default(bank_transfer)
  reference     String? // Bank reference/transaction ID
  status        PaymentStatus @default(PAID)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])
  tenant  Tenant  @relation(fields: [tenantId], references: [id])

  @@index([invoiceId])
  @@index([tenantId])
  @@index([paidAt])
  @@map("invoice_payments")
}

model PaymentItem {
  id            String          @id @default(uuid())
  paymentId     String
  orderId       String
  orderItemId   String
  productName   String
  quantity      Int
  unitPrice     Float
  depositAmount Float           @default(0)
  totalAmount   Float
  order         Order           @relation(fields: [orderId], references: [id])
  orderItem     OrderItem       @relation(fields: [orderItemId], references: [id])
  payment       CustomerPayment @relation(fields: [paymentId], references: [id]) // Changed to CustomerPayment

  @@map("payment_items")
}

model ProductInventory {
  id           String   @id @default(uuid())
  productId    String   @unique
  tenantId     String
  currentStock Int      @default(0)
  totalAdded   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String?
  totalSold    Int      @default(0)
  product      Product  @relation("ProductInventoryRelation", fields: [productId], references: [id])
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  @@unique([productId, tenantId])
  @@index([tenantId])
  @@index([productId])
  @@map("product_inventories")
}

model BottleInventory {
  id             String @id @default(uuid())
  tenantId       String @unique
  totalPurchased Int    @default(0)
  inStock        Int    @default(0)
  withCustomers  Int    @default(0)
  damaged        Int    @default(0)
  leaked         Int    @default(0)
  repairable     Int    @default(0)
  lost           Int    @default(0)
  tenant         Tenant @relation(fields: [tenantId], references: [id])

  @@map("bottle_inventories")
}

model Zone {
  id          String     @id @default(uuid())
  name        String
  description String?
  status      String     @default("active")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  tenantId    String
  userId      String?
  customers   Customer[]
  drivers     Driver[]
  orders      Order[]
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  user        User?      @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
  @@map("zones")
}

model Customer {
  id               String            @id @default(uuid())
  name             String
  phone            String
  address          String
  email            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  tenantId         String
  bottlesGiven     Int               @default(0)
  dueAmount        Float             @default(0)
  empties          Int               @default(0)
  lastOrderDate    DateTime?
  securityDeposit  Float             @default(0)
  sleepingSince    DateTime?
  totalSpent       Float             @default(0)
  city             String?
  country          String?
  postalCode       String?
  zoneId           String?
  status           CustomerStatus    @default(active)
  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  zone             Zone?             @relation(fields: [zoneId], references: [id])
  orders           Order[]
  customerPayments CustomerPayment[]
  subscriptions    Subscription[]

  @@unique([phone, tenantId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([phone])
  @@index([lastOrderDate])
  @@index([zoneId])
  @@map("customers")
}

model Driver {
  id               String            @id @default(uuid())
  name             String
  phone            String
  zoneId           String
  status           String            @default("active")
  rating           Float?
  totalDeliveries  Int               @default(0)
  todayDeliveries  Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  tenantId         String
  userId           String?
  totalRatings     Int               @default(0)
  vehicleNumber    String
  vehicleType      String
  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  user             User?             @relation(fields: [userId], references: [id])
  zone             Zone              @relation(fields: [zoneId], references: [id])
  orders           Order[]
  customerPayments CustomerPayment[]

  @@unique([phone, tenantId])
  @@unique([vehicleNumber, tenantId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([zoneId])
  @@index([phone])
  @@index([vehicleNumber])
  @@index([status])
  @@map("drivers")
}

model Subscription {
  id                String             @id @default(uuid())
  customerId        String
  tenantId          String
  productId         String
  quantity          Int                @default(1)
  recurrence        OrderRecurrence    @default(WEEKLY)
  deliveryDayOfWeek Int
  nextDeliveryDate  DateTime
  lastDeliveredDate DateTime?
  preferredTime     String?
  notificationTime  Int                @default(21)
  status            SubscriptionStatus @default(ACTIVE)
  totalDeliveries   Int                @default(0)
  missedDeliveries  Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  orders            Order[]
  customerPayments  CustomerPayment[]
  customer          Customer           @relation(fields: [customerId], references: [id])
  product           Product            @relation(fields: [productId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])

  @@unique([customerId, productId, recurrence, deliveryDayOfWeek])
  @@index([customerId])
  @@index([tenantId])
  @@index([status])
  @@index([nextDeliveryDate])
  @@map("subscriptions")
}

model Order {
  id                      String            @id @default(uuid())
  orderNumber             Int               @unique @default(autoincrement())
  orderNumberDisplay      String?
  customerId              String
  driverId                String?
  zoneId                  String
  deliveryDate            DateTime
  deliveryAddress         String
  totalAmount             Float
  paymentMethod           PaymentMethod     @default(cash_on_delivery)
  status                  OrderStatus       @default(pending)
  tenantId                String
  createdById             String?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  acceptableDepositAmount Float             @default(0)
  scheduledDate           DateTime?
  isRecurring             Boolean           @default(false)
  nextRecurringDate       DateTime?
  notificationSent        Boolean           @default(false)
  recurrence              OrderRecurrence   @default(NONE)
  subscriptionId          String?
  withBottles             Boolean           @default(true)
  paidAmount              Float             @default(0)
  paymentId               String?
  paymentStatus           PaymentStatus     @default(PENDING)
  items                   OrderItem[]
  createdBy               User?             @relation(fields: [createdById], references: [id])
  customer                Customer          @relation(fields: [customerId], references: [id])
  driver                  Driver?           @relation(fields: [driverId], references: [id])
  subscription            Subscription?     @relation(fields: [subscriptionId], references: [id])
  tenant                  Tenant            @relation(fields: [tenantId], references: [id])
  zone                    Zone              @relation(fields: [zoneId], references: [id])
  paymentItems            PaymentItem[]
  customerPayments        CustomerPayment[]

  @@index([subscriptionId])
  @@index([isRecurring])
  @@index([nextRecurringDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deliveryDate])
  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([driverId])
  @@index([orderNumberDisplay])
  @@index([tenantId, deliveryDate, status])
  @@map("orders")
}

model OrderItem {
  id            String        @id @default(uuid())
  orderId       String
  productId     String
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  depositAmount Float         @default(0)
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])
  paymentItems  PaymentItem[]

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model CompanyTariff {
  id        String @id @default(uuid())
  companyId String
  tariffId  String

  assignedAt    DateTime  @default(now())
  assignedBy    String?
  isActive      Boolean   @default(true)
  effectiveFrom DateTime?

  tenant Tenant @relation(fields: [companyId], references: [id])
  tariff Tariff @relation(fields: [tariffId], references: [id])

  @@index([companyId, effectiveFrom])
  @@index([companyId])
  @@index([companyId, isActive])
}

model TariffSlab {
  id          String      @id @default(uuid())
  tariffId    String
  productType ProductType

  fromQty      Int // inclusive
  toQty        Int? // null = infinity
  pricePerUnit Decimal? // Used for REUSABLE (fixed per unit)
  percentage   Decimal? // NEW: Used for NON_REUSABLE (% of subtotal)

  createdAt DateTime @default(now())

  tariff Tariff @relation(fields: [tariffId], references: [id], onDelete: Cascade)

  @@index([tariffId, productType])
}

model Tariff {
  id          String  @id @default(uuid())
  name        String
  description String?
  isActive    Boolean @default(true)

  effectiveFrom DateTime
  effectiveTo   DateTime?
  assignedBy    String?
  createdBy     String // super_admin id
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  isDefault     Boolean         @default(false) // ðŸ‘ˆ KEY CHANGE
  slabs         TariffSlab[]
  companyLinks  CompanyTariff[]

  @@index([isActive])
}

enum InvoiceStatus {
  DRAFT
  GENERATED
  PAID
}

model Invoice {
  id          String   @id @default(uuid())
  companyId   String
  periodStart DateTime
  periodEnd   DateTime

  totalAmount Decimal
  paidAmount  Decimal @default(0)

  billingStatus BillingStatus  @default(UNPAID)
  status        InvoiceStatus?
  dueDate       DateTime       @default(now()) // ðŸ”¹ temporary default for migration

  generatedAt DateTime  @default(now())
  paidAt      DateTime?

  lineItems InvoiceLineItem[]

  company Tenant @relation(fields: [companyId], references: [id])

  payments InvoicePayment[]

  @@index([companyId, periodStart, periodEnd])
}

model InvoiceLineItem {
  id        String @id @default(uuid())
  invoiceId String

  productType   ProductType
  fromQty       Int
  toQty         Int?
  unitPrice     Decimal? // For REUSABLE: pricePerUnit
  percentage    Decimal? // NEW: For NON_REUSABLE: percentage
  baseAmount    Decimal? // NEW: For percentage lines: the subtotal the % was applied to
  quantity      Int
  amount        Decimal
  tariffId      String? // optional
  slabId        String? // optional
  effectiveDate DateTime?
  invoice       Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

enum UserRole {
  super_admin
  company_admin
  company_user
}

enum OrderStatus {
  pending
  confirmed
  in_progress
  out_for_delivery
  delivered
  completed
  cancelled
  failed
  assigned
  // scheduled
}

enum PaymentMethod {
  cash_on_delivery
  card
  wallet
  bank_transfer
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum PaymentCollectionType {
  IMMEDIATE
  MONTHLY
  CYCLE
}

enum CustomerStatus {
  active
  inactive
  sleeping
  overdue
}

enum OrderRecurrence {
  NONE
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum ProductType {
  REUSABLE
  NON_REUSABLE
}

enum BillingStatus {
  PAID
  PARTIAL
  UNPAID
  OVERDUE
  SUSPENDED
}
